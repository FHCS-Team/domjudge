<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Query Optimization Challenge</title>
    <style>
        .problem-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .section {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .section h3 {
            color: #34495e;
            margin-top: 25px;
        }

        .highlight {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }

        .danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
        }

        .success {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .query-box {
            background: #263238;
            color: #82aaff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .spec-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .scoring-table th,
        .scoring-table td {
            border: 1px solid #e1e5e9;
            padding: 15px 12px;
            text-align: left;
            vertical-align: top;
        }

        .scoring-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .scoring-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .scoring-table tbody tr:hover {
            background: #e9ecef;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            color: white;
        }

        .badge-primary {
            background: #007bff;
        }

        .badge-warning {
            background: #ffc107;
            color: #212529;
        }

        .badge-danger {
            background: #dc3545;
        }

        .badge-success {
            background: #28a745;
        }

        .timeline {
            border-left: 3px solid #007bff;
            padding-left: 20px;
            margin: 20px 0;
        }

        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-item::before {
            content: '●';
            position: absolute;
            left: -28px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }
    </style>
</head>

<body>
    <div class="problem-container">
        <div class="header">
            <h1>Database Query Optimization Challenge</h1>
            <p>Tối ưu truy vấn CSDL cho hệ thống phân tích lớn</p>
        </div>

        <div class="section">
            <h2>Mô tả bài toán</h2>
            <p>Các hệ thống phân tích và OLTP lớn thường gặp phải tình trạng truy vấn trở nên chậm đến mức không thể sử
                dụng khi dữ liệu mở rộng (ví dụ: hơn <strong>100 triệu hàng</strong>). Trong quá trình vận hành, điều
                này gây ra sự chậm trễ trong bảng điều khiển, quy trình ETL và các tính năng của khách hàng.</p>

            <div class="highlight">
                <strong>Nhiệm vụ:</strong> Làm cho một khối lượng công việc SQL chậm nhất định chạy ở tốc độ chấp
                nhận được trên một máy duy nhất bằng cách áp dụng các thay đổi về lược đồ/chỉ mục/truy vấn thực dụng và
                kỹ thuật nhẹ.
            </div>

            <p><strong>Domain:</strong> Databases, query optimization, systems engineering, data engineering.</p>
        </div>

        <div class="section">
            <h2>Format nộp bài</h2>
            <p>Thí sinh nộp một file <strong>zip</strong> (hoặc Docker image) chứa các file sau:</p>
            <ul>
                <li><code>migration.sql</code> — DDL/DML tạo bảng/index/view cần thiết</li>
                <li><code>Q&lt;N&gt;.sql</code> — các query được viết lại và các lệnh SQL phụ trợ (hàm, view)</li>
                <li><code>run_tests.sh</code> — script chạy test và xuất báo cáo</li>
                <li><strong>Optional:</strong> <code>explanation.txt/README.md</code> mô tả các thay đổi và lí do (tối
                    đa 500 từ)</li>
            </ul>

            <div class="danger">
                <strong>Lưu ý quan trọng:</strong> Bài nộp KHÔNG ĐƯỢC PHÉP chứa bảng kết quả tính sẵn tương ứng với
                query thử. Thí sinh có thể tạo và sử dụng index, materialized view, summary table, aggregate.
            </div>
        </div>

        <div class="section">
            <h2>Constraints & Specifications</h2>
            <div class="specs-grid">
                <div class="spec-card">
                    <h3>Technical Requirements</h3>
                    <ul>
                        <li><strong>DB:</strong> PostgreSQL 14</li>
                        <li><strong>Dataset:</strong> ~100M events + 120M total records</li>
                        <li><strong>Hardware:</strong> 8 vCPU, 32GB RAM, 1TB SSD</li>
                    </ul>
                </div>
                <div class="spec-card">
                    <h3>Time Limits</h3>
                    <ul>
                        <li><strong>Migration:</strong> 30 phút max</li>
                        <li><strong>Query target:</strong> 4s mục tiêu</li>
                        <li><strong>Query timeout:</strong> 10s (fail)</li>
                    </ul>
                </div>
                <div class="spec-card">
                    <h3>Storage Constraints</h3>
                    <ul>
                        <li><strong>Target:</strong> ≤ 30% extra storage</li>
                        <li><strong>Max:</strong> 100% extra = 0 điểm</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Database Schema</h2>
            <div class="query-box">
                -- events: main table 100 triệu+ bản ghi
                CREATE TABLE events (
                event_id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL,
                device_id BIGINT,
                event_type VARCHAR(50),
                event_ts TIMESTAMP WITHOUT TIME ZONE NOT NULL,
                payload JSONB
                );

                -- users: 10 triệu bản ghi
                CREATE TABLE users (
                user_id BIGINT PRIMARY KEY,
                signup_ts TIMESTAMP,
                country CHAR(2),
                plan VARCHAR(20)
                );

                -- devices: 5 triệu bản ghi
                CREATE TABLE devices (
                device_id BIGINT PRIMARY KEY,
                device_type VARCHAR(30),
                os_version VARCHAR(20)
                );
            </div>
        </div>

        <div class="section">
            <h2>Benchmark Queries</h2>

            <h3>Q1: Count of events per event_type for active users in last 30 days</h3>
            <div class="query-box">
                SELECT e.event_type, count(*) as cnt
                FROM events e
                JOIN users u ON u.user_id = e.user_id
                WHERE e.event_ts >= now() - interval '30 days'
                AND u.plan = 'pro'
                GROUP BY e.event_type
                ORDER BY cnt DESC;
            </div>

            <h3>Q2: Recent distinct device types used by users from country 'VN'</h3>
            <div class="query-box">
                SELECT distinct d.device_type
                FROM events e
                JOIN devices d ON d.device_id = e.device_id
                JOIN users u ON u.user_id = e.user_id
                WHERE u.country = 'VN'
                AND (e.payload->>'flag') = 'true'
                AND e.event_ts BETWEEN now() - interval '7 days' AND now();
            </div>

            <h3>Q3: Top 100 users by purchases in last 90 days</h3>
            <div class="query-box">
                SELECT e.user_id, u.signup_ts, count(*) AS purchases
                FROM events e
                JOIN users u ON u.user_id = e.user_id
                WHERE e.event_type = 'purchase'
                AND e.event_ts >= now() - interval '90 days'
                GROUP BY e.user_id, u.signup_ts
                ORDER BY purchases DESC
                LIMIT 100;
            </div>
        </div>

        <div class="section">
            <h2>Scoring Criteria</h2>
            <table class="scoring-table">
                <thead>
                    <tr>
                        <th>Tiêu chí</th>
                        <th>Trọng số</th>
                        <th>Mô tả</th>
                        <th>Công thức</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-primary">Chính xác</span></td>
                        <td><strong>50%</strong></td>
                        <td>Kết quả đúng và đầy đủ</td>
                        <td>100 điểm nếu hoàn toàn chính xác</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">Độ trễ</span></td>
                        <td><strong>30%</strong></td>
                        <td>Tốc độ thực thi query</td>
                        <td>clamp(4000ms / median_time_ms, 0, 1)</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">Chịu tải</span></td>
                        <td><strong>10%</strong></td>
                        <td>Throughput 10 client đồng thời</td>
                        <td>clamp(measured/10 qps, 0, 1)</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">Tài nguyên</span></td>
                        <td><strong>10%</strong></td>
                        <td>Storage sử dụng thêm</td>
                        <td>clamp(1 - extra/0.3*base, 0, 1)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Optimization Techniques</h2>
            <div class="specs-grid">
                <div class="spec-card">
                    <h3>Allowed Techniques</h3>
                    <ul>
                        <li>Indexes (composite, partial)</li>
                        <li>Partitioning</li>
                        <li>Materialized views</li>
                        <li>Summary tables</li>
                        <li>Query rewriting</li>
                        <li>PL/pgSQL functions</li>
                        <li>CLUSTER, VACUUM ANALYZE</li>
                    </ul>
                </div>
                <div class="spec-card">
                    <h3>Prohibited Techniques</h3>
                    <ul>
                        <li>Kết quả tính sẵn</li>
                        <li>Remote databases</li>
                        <li>Distributed processing</li>
                        <li>Thay đổi test kit</li>
                        <li>Data dumps của kết quả</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2> Evaluation Flow</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <h4>1. Data Loading</h4>
                    <p>Load 100M+ records into PostgreSQL database</p>
                </div>
                <div class="timeline-item">
                    <h4>2. Migration</h4>
                    <p>Run <code>psql -f migration.sql</code> (30min timeout)</p>
                </div>
                <div class="timeline-item">
                    <h4>3. Query Testing</h4>
                    <p>Execute Q1, Q2, Q3 × 3 times each (1 warmup + 2 scored)</p>
                </div>
                <div class="timeline-item">
                    <h4>4. Concurrency Test</h4>
                    <p>10 concurrent clients for 30 seconds</p>
                </div>
                <div class="timeline-item">
                    <h4>5. Scoring</h4>
                    <p>Calculate final score based on criteria</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Optimization Hints</h2>
            <div class="success">
                <ul>
                    <li><strong>Indexes:</strong> Add on (event_type, event_ts), composite indexes for join keys</li>
                    <li><strong>Partitioning:</strong> Range partition by event_ts to limit scanned data</li>
                    <li><strong>Materialized Views:</strong> Pre-aggregate heavy joins</li>
                    <li><strong>Partial Indexes:</strong> Only for event_type='purchase' or payload->>'flag' = 'true'
                    </li>
                    <li><strong>Query Rewriting:</strong> Avoid SELECT DISTINCT over huge joins</li>
                    <li><strong>Analysis:</strong> Use EXPLAIN (ANALYZE, BUFFERS) for optimization</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Output Format</h2>
            <p>Script <code>run_tests.sh</code> phải xuất ra báo cáo:</p>
            <pre>QUERY q1: OK, time_ms=123
QUERY q2: OK, time_ms=45
QUERY q3: OK, time_ms=67</pre>

            <div class="warning">
                <strong>Quan trọng:</strong> Kết quả phải trả về đúng thứ tự như query nguyên bản. Output sẽ được so
                khớp 1-1 với kết quả chuẩn.
            </div>
        </div>

        <div class="section">
            <h2>Tie-breaking Rules</h2>
            <ol>
                <li>Điểm chính xác cao hơn</li>
                <li>Median time thấp hơn</li>
                <li>Sử dụng storage ít hơn</li>
                <li>Migration nhanh hơn</li>
            </ol>

            <div class="danger">
                <strong>Special Case:</strong> Nếu migration lỗi (syntax error / crashes), bài nộp nhận <strong>0
                    điểm</strong>
            </div>
        </div>
    </div>
</body>

</html>